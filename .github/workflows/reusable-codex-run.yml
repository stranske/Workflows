name: Reusable Codex Run

on:
  workflow_call:
    inputs:
      prompt_file:
        description: 'Path to the prompt file that Codex should read.'
        required: true
        type: string
      mode:
        description: 'Codex mode for logging purposes (keepalive | autofix | verifier).'
        required: false
        default: keepalive
        type: string
      pr_number:
        description: 'Optional pull request number (used for logging or comments by callers).'
        required: false
        default: ''
        type: string
      max_runtime_minutes:
        description: 'Upper bound for the job runtime in minutes.'
        required: false
        default: 45
        type: number
      sandbox:
        description: 'Sandbox mode to pass through to Codex.'
        required: false
        default: workspace-write
        type: string
      safety_strategy:
        description: 'Safety strategy to pass through to Codex.'
        required: false
        default: drop-sudo
        type: string
      codex_args:
        description: 'Optional Codex CLI arguments (string or JSON array).'
        required: false
        default: ''
        type: string
      appendix:
        description: 'Optional context appended to the prompt passed to Codex.'
        required: false
        default: ''
        type: string
    secrets:
      OPENAI_API_KEY:
        required: true
      WORKFLOWS_APP_ID:
        required: false
      WORKFLOWS_APP_PRIVATE_KEY:
        required: false

permissions:
  contents: write
  pull-requests: write
  actions: write

jobs:
  codex:
    name: Codex (${{ inputs.mode }})
    runs-on: ubuntu-latest
    timeout-minutes: ${{ inputs.max_runtime_minutes }}
    outputs:
      final-message: ${{ steps.run_codex.outputs.final-message }}
    steps:
      - name: Mint GitHub App token (preferred)
        id: app_token
        continue-on-error: true
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.WORKFLOWS_APP_ID }}
          private-key: ${{ secrets.WORKFLOWS_APP_PRIVATE_KEY }}

      - name: Select auth token
        id: auth_token
        env:
          APP_TOKEN: ${{ steps.app_token.outputs.token || '' }}
        run: |
          set -euo pipefail
          checkout_token="${APP_TOKEN:-${GITHUB_TOKEN}}"
          push_token="${APP_TOKEN:-}"
          source="app-token"
          push_allowed="true"

          if [ -z "$push_token" ]; then
            source="github-token"
            push_allowed="false"
          fi

          {
            echo "checkout_token=${checkout_token}"
            echo "push_token=${push_token}"
            echo "source=${source}"
            echo "push_allowed=${push_allowed}"
          } >> "$GITHUB_OUTPUT"

          {
            echo "WORKFLOWS_TOKEN=${checkout_token}"
            echo "CODEX_MODE=${{ inputs.mode }}"
            echo "CODEX_PR_NUMBER=${{ inputs.pr_number }}"
          } >> "$GITHUB_ENV"

          printf 'Checkout auth: %s; push permitted with app token: %s.\n' "$source" "$push_allowed"

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ steps.auth_token.outputs.checkout_token }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: pip
          cache-dependency-path: |
            pyproject.toml
            requirements*.txt

      - name: Install Python dependencies
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            python -m pip install -r requirements.txt
          else
            echo "requirements.txt not found; skipping base requirements install."
          fi

          if [ -f requirements-dev.txt ]; then
            python -m pip install -r requirements-dev.txt
          else
            echo "requirements-dev.txt not found; skipping dev requirements file."
          fi

          if [ -f tools/requirements.txt ]; then
            python -m pip install -r tools/requirements.txt
          else
            echo "tools/requirements.txt not found; skipping tools requirements."
          fi

          if [ -f scripts/requirements.txt ]; then
            python -m pip install -r scripts/requirements.txt
          else
            echo "scripts/requirements.txt not found; skipping scripts requirements."
          fi

          if [ -f pyproject.toml ]; then
            python -m pip install -e ".[dev]" || python -m pip install -e .
          fi
      - name: Assemble prompt
        id: prompt
        env:
          BASE_PROMPT: ${{ inputs.prompt_file }}
          APPENDIX: ${{ inputs.appendix }}
        run: |
          set -euo pipefail
          base="${BASE_PROMPT}"
          output="codex-prompt.md"

          if [ -z "$base" ] || [ ! -f "$base" ]; then
            echo "Base prompt file not found: ${base}" >&2
            exit 1
          fi

          cat "$base" > "$output"

          if [ -n "$APPENDIX" ]; then
            {
              echo
              echo "## Run context"
              printf '%s\n' "$APPENDIX"
            } >> "$output"
          fi

          echo "file=${output}" >> "$GITHUB_OUTPUT"

      - name: Run Codex
        id: run_codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          prompt-file: ${{ steps.prompt.outputs.file }}
          output-file: codex-output.md
          sandbox: ${{ inputs.sandbox }}
          safety-strategy: ${{ inputs.safety_strategy }}
          codex-args: ${{ inputs.codex_args }}

      - name: Commit and push changes
        env:
          MODE: ${{ inputs.mode }}
          PR_NUMBER: ${{ inputs.pr_number }}
          PUSH_ALLOWED: ${{ steps.auth_token.outputs.push_allowed }}
          PUSH_TOKEN: ${{ steps.auth_token.outputs.push_token }}
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if [ -z "$(git status --porcelain)" ]; then
            echo "No changes to commit."
            exit 0
          fi

          commit_message="chore(codex-${MODE}): apply updates"
          if [ -n "$PR_NUMBER" ]; then
            commit_message="${commit_message} (PR #${PR_NUMBER})"
          fi

          if [ "$PUSH_ALLOWED" != "true" ]; then
            echo "GitHub App token missing; refusing to push without app identity to preserve workflow triggers."
            exit 1
          fi

          git add -A
          git commit -m "$commit_message"
          git push https://x-access-token:${PUSH_TOKEN}@github.com/${{ github.repository }} HEAD:${{ github.ref_name }}

      - name: Upload Codex output
        if: always() && hashFiles('codex-output.md') != ''
        uses: actions/upload-artifact@v4
        with:
          name: codex-output
          path: codex-output.md
