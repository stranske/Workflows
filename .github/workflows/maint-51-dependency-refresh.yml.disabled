name: Maint 51 Dependency Refresh

on:
  schedule:
    - cron: '0 4 1,15 * *'  # 1st and 15th of each month at 04:00 UTC
  workflow_dispatch:
    inputs:
      dry-run:
        description: 'Preview only (do not open a pull request)'
        required: false
        default: 'false'

permissions:
  contents: write
  pull-requests: write

jobs:
  refresh:
    name: Refresh dependency pins
    runs-on: ubuntu-latest
    env:
      DRY_RUN: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.dry-run || 'false' }}
      BASE_BRANCH: ${{ github.event.repository.default_branch }}
    steps:
      - name: Checkout default branch
        uses: actions/checkout@v4
        with:
          ref: ${{ env.BASE_BRANCH }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        run: |
          set -euo pipefail
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Refresh requirements.lock
        run: |
          set -euo pipefail
          uv pip compile --upgrade pyproject.toml --extra app --extra dev --extra notebooks -o requirements.lock

      - name: Verify lockfile aligns with current compile
        env:
          TREND_FORCE_DEP_LOCK_CHECK: "1"
        run: |
          set -euo pipefail
          python - <<'PY'
          import re
          import subprocess
          from pathlib import Path

          def normalize(content: str) -> str:
              lines: list[str] = []
              for line in content.splitlines():
                  stripped = line.strip()
                  if not stripped:
                      continue
                  if stripped.startswith('#'):
                      if re.match(r'^#.*autogenerated.*by.*', stripped, re.IGNORECASE):
                          continue
                      if re.match(r'^#\s*uv pip compile.*', stripped):
                          lines.append('#    uv pip compile pyproject.toml --extra app --extra dev --extra notebooks -o requirements.lock')
                          continue
                      if re.search(r'\d{4}-\d{2}-\d{2}', stripped) or re.search(r'\d{2}:\d{2}', stripped):
                          continue
                      if (
                          stripped == '# via'
                          or stripped.startswith('#   ')
                          or re.match(r'^#\s+via\s+\w', stripped)
                      ):
                          continue
                      lines.append(stripped)
                  else:
                      lines.append(stripped)
              return '\n'.join(lines) + ('\n' if lines else '')

          compiled_proc = subprocess.run(
              ['uv', 'pip', 'compile', 'pyproject.toml', '--extra', 'app', '--extra', 'dev', '--extra', 'notebooks'],
              check=True,
              capture_output=True,
              text=True,
          )
          compiled = normalize(compiled_proc.stdout)
          lock_path = Path('requirements.lock')
          existing = normalize(lock_path.read_text())
          if compiled != existing:
              raise SystemExit('requirements.lock is out of date; run the scheduled refresh workflow to update it.')
          PY

      - name: Verify tool pins remain aligned
        run: python -m scripts.sync_tool_versions --check

      - name: Detect changes
        id: diff
        run: |
          set -euo pipefail
          if git diff --stat --exit-code >/dev/null; then
              echo "changed=false" >> "$GITHUB_OUTPUT"
              echo "No dependency updates detected."
          else
              echo "changed=true" >> "$GITHUB_OUTPUT"
              echo "Dependency updates detected:" >> "$GITHUB_STEP_SUMMARY"
              git status --short | sed 's/^/  /'
          fi

      - name: Run dependency verification
        if: steps.diff.outputs.changed == 'true'
        run: |
          set -euo pipefail
          python scripts/sync_test_dependencies.py --verify

      - name: Create dependency refresh PR
        if: steps.diff.outputs.changed == 'true' && env.DRY_RUN != 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          branch: maintenance/dependency-refresh/${{ github.run_id }}
          base: ${{ env.BASE_BRANCH }}
          commit-message: "chore(deps): refresh dependency snapshot"
          title: "chore(deps): refresh dependency snapshot"
          body: |
            ## Dependency snapshot refresh

            * Workflow run: ${{ github.run_id }}
            * Trigger: ${{ github.event_name }}

            Changes produced by `Maint 51 Dependency Refresh`.
          labels: maintenance,dependencies

      - name: Dry-run summary
        if: steps.diff.outputs.changed == 'true' && env.DRY_RUN == 'true'
        run: |
          echo "Dry run requested. Pending changes were detected but no PR was opened." >> "$GITHUB_STEP_SUMMARY"

      - name: No-op summary
        if: steps.diff.outputs.changed != 'true'
        run: echo "Dependency snapshot already up to date." >> "$GITHUB_STEP_SUMMARY"
