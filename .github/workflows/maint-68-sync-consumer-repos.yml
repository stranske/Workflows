name: Maint 68 Sync Consumer Repos

# Push workflow template updates to registered consumer repositories
# Triggered after releases, template changes, or manually

on:
  release:
    types: [published]
  push:
    branches: [main]
    paths:
      - 'templates/consumer-repo/**'
      # NOTE: We do NOT sync autofix-versions.env - each repo maintains its own
      # dependency versions based on its lock files
  workflow_dispatch:
    inputs:
      repos:
        description: 'Comma-separated repos to sync (empty for all registered)'
        type: string
        required: false
      dry_run:
        description: 'Preview changes without creating PRs'
        type: boolean
        default: false
      force:
        description: 'Force sync even if no changes detected'
        type: boolean
        default: false

permissions:
  contents: read

env:
  # Consumer repos registered for automatic sync
  # Add new repos here as they're onboarded
  # NOTE: Repos with custom Gate workflows (trip-planner, Manager-Database)
  # still get synced for agent workflows - only pr-00-gate.yml is repo-specific
  REGISTERED_CONSUMER_REPOS: |
    stranske/Travel-Plan-Permission
    stranske/Template
    stranske/trip-planner
    stranske/Manager-Database

jobs:
  prepare:
    name: Prepare sync manifest
    runs-on: ubuntu-latest
    outputs:
      repos: ${{ steps.repos.outputs.matrix }}
      template_hash: ${{ steps.hash.outputs.hash }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            templates/consumer-repo
          sparse-checkout-cone-mode: false

      - name: Compute template hash
        id: hash
        run: |
          hash=$(find templates/consumer-repo -type f -exec sha256sum {} \; | sort | sha256sum | cut -d' ' -f1)
          echo "hash=${hash:0:12}" >> "$GITHUB_OUTPUT"
          echo "Template hash: ${hash:0:12}"

      - name: Build repo matrix
        id: repos
        run: |
          if [ -n "${{ inputs.repos }}" ]; then
            repos='${{ inputs.repos }}'
          else
            repos=$(echo "$REGISTERED_CONSUMER_REPOS" | tr '\n' ',' | sed 's/,$//')
          fi

          # Convert to JSON array
          json_array=$(echo "$repos" | tr ',' '\n' | grep -v '^$' | jq -R -s -c 'split("\n") | map(select(. != "")) | map(gsub("^\\s+|\\s+$"; ""))')
          echo "matrix={\"repo\":$json_array}" >> "$GITHUB_OUTPUT"
          echo "Repos to sync: $json_array"

  sync:
    name: Sync ${{ matrix.repo }}
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare.outputs.repos) }}
    env:
      SYNC_TOKEN: ${{ secrets.CODESPACES_WORKFLOWS || secrets.SERVICE_BOT_PAT }}
    steps:
      - name: Checkout Workflows templates
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            templates/consumer-repo
            .github/workflows/agents-63-issue-intake.yml
            .github/scripts
          sparse-checkout-cone-mode: false
          path: workflows

      - name: Clone consumer repo
        env:
          GH_TOKEN: ${{ env.SYNC_TOKEN }}
        run: |
          gh repo clone ${{ matrix.repo }} consumer -- --depth=1

      - name: Detect sync-able files
        id: detect
        run: |
          set -euo pipefail

          # Files that should be synced (thin callers from templates)
          # NOTE: autofix-versions.env is NOT synced - each repo maintains its own
          # NOTE: agents-63-issue-intake.yml is NOT a thin caller - it uses local scripts
          #       and should be synced from .github/workflows/, not templates/
          SYNC_FILES=(
            "agents-orchestrator.yml:agents-orchestrator.yml"
            "agents-orchestrator.yml:agents-70-orchestrator.yml"
            "agents-pr-meta.yml:agents-pr-meta.yml"
            "agents-keepalive-loop.yml:agents-keepalive-loop.yml"
            "agents-verifier.yml:agents-verifier.yml"
            "autofix.yml:autofix.yml"
            "pr-00-gate.yml:pr-00-gate.yml"
          )

          # Full workflows synced from .github/workflows/ (not templates)
          FULL_WORKFLOWS=(
            "agents-63-issue-intake.yml"
          )

          # Scripts that need to be synced for full workflows
          SYNC_SCRIPTS=(
            "decode_raw_input.py"
            "parse_chatgpt_topics.py"
            "fallback_split.py"
          )

          # Codex prompts and instructions (required for keepalive to work)
          SYNC_CODEX_FILES=(
            "AGENT_INSTRUCTIONS.md"
            "prompts/keepalive_next_task.md"
          )

          # Issue templates for agent automation
          SYNC_ISSUE_TEMPLATES=(
            "agent_task.yml"
            "config.yml"
          )

          # Documentation files for agent pipeline
          # Documentation files for agent pipeline
          SYNC_DOCS=(
            "AGENT_ISSUE_FORMAT.md"
            "CI_SYSTEM_GUIDE.md"
            "LABELS.md"
          )

          # GitHub config files
          SYNC_GITHUB_CONFIG=(
            "PULL_REQUEST_TEMPLATE.md"
          )

          # Root config files from template
          SYNC_ROOT_CONFIGS=(
            ".gitignore"
          )

          changes=""
          sync_report=""

          # Helper function to compare files safely
          compare_files() {
            local file1="$1"
            local file2="$2"
            local skip_header="${3:-false}"

            if [ "$skip_header" = "true" ]; then
              local lines1 lines2
              lines1=$(wc -l < "$file1")
              lines2=$(wc -l < "$file2")

              # If either file is too short, compare entire files
              if [ "$lines1" -lt 15 ] || [ "$lines2" -lt 15 ]; then
                diff -q "$file1" "$file2" > /dev/null 2>&1
              else
                diff -q <(tail -n +10 "$file1") <(tail -n +10 "$file2") > /dev/null 2>&1
              fi
            else
              diff -q "$file1" "$file2" > /dev/null 2>&1
            fi
          }

          # Repos with custom Gate workflows - skip pr-00-gate.yml detection for these
          CUSTOM_GATE_REPOS="stranske/trip-planner stranske/Manager-Database"
          CURRENT_REPO="${{ matrix.repo }}"

          # Check thin caller templates
          for mapping in "${SYNC_FILES[@]}"; do
            template_name="${mapping%%:*}"
            consumer_name="${mapping##*:}"

            # Skip pr-00-gate.yml detection for repos with custom Gate workflows
            if [ "$template_name" = "pr-00-gate.yml" ] && echo "$CUSTOM_GATE_REPOS" | grep -qw "$CURRENT_REPO"; then
              continue
            fi

            template_file="workflows/templates/consumer-repo/.github/workflows/$template_name"
            consumer_file="consumer/.github/workflows/$consumer_name"

            # Skip if template doesn't exist (nothing to sync from)
            if [ ! -f "$template_file" ]; then
              continue
            fi

            # Mark as change if consumer file is missing (new workflow to add)
            if [ ! -f "$consumer_file" ]; then
              changes="$changes $consumer_name"
              sync_report="$sync_report\n- $consumer_name (missing, will be created)"
              continue
            fi

            if ! compare_files "$template_file" "$consumer_file" true; then
              changes="$changes $consumer_name"
              sync_report="$sync_report\n- $consumer_name (differs from template)"
            fi
          done

          # Check full workflows (from .github/workflows/)
          for workflow in "${FULL_WORKFLOWS[@]}"; do
            source_file="workflows/.github/workflows/$workflow"
            consumer_file="consumer/.github/workflows/$workflow"

            if [ ! -f "$source_file" ] || [ ! -f "$consumer_file" ]; then
              continue
            fi

            if ! compare_files "$source_file" "$consumer_file" true; then
              changes="$changes $workflow"
              sync_report="$sync_report\n- $workflow (differs from source)"
            fi
          done

          # Check scripts
          for script in "${SYNC_SCRIPTS[@]}"; do
            source_file="workflows/.github/scripts/$script"
            consumer_file="consumer/.github/scripts/$script"

            if [ ! -f "$source_file" ]; then
              continue
            fi

            if [ ! -f "$consumer_file" ]; then
              changes="$changes scripts/$script"
              sync_report="$sync_report\n- scripts/$script (missing)"
            elif ! compare_files "$source_file" "$consumer_file" false; then
              changes="$changes scripts/$script"
              sync_report="$sync_report\n- scripts/$script (differs)"
            fi
          done

          # Check codex prompts and instructions
          for codex_file in "${SYNC_CODEX_FILES[@]}"; do
            source_file="workflows/templates/consumer-repo/.github/codex/$codex_file"
            consumer_file="consumer/.github/codex/$codex_file"

            if [ ! -f "$source_file" ]; then
              continue
            fi

            if [ ! -f "$consumer_file" ]; then
              changes="$changes codex/$codex_file"
              sync_report="$sync_report\n- codex/$codex_file (missing)"
            elif ! compare_files "$source_file" "$consumer_file" false; then
              changes="$changes codex/$codex_file"
              sync_report="$sync_report\n- codex/$codex_file (differs)"
            fi
          done

          # Check issue templates
          for template_file in "${SYNC_ISSUE_TEMPLATES[@]}"; do
            source_file="workflows/templates/consumer-repo/.github/ISSUE_TEMPLATE/$template_file"
            consumer_file="consumer/.github/ISSUE_TEMPLATE/$template_file"

            if [ ! -f "$source_file" ]; then
              continue
            fi

            if [ ! -f "$consumer_file" ]; then
              changes="$changes ISSUE_TEMPLATE/$template_file"
              sync_report="$sync_report\n- ISSUE_TEMPLATE/$template_file (missing)"
            elif ! compare_files "$source_file" "$consumer_file" false; then
              changes="$changes ISSUE_TEMPLATE/$template_file"
              sync_report="$sync_report\n- ISSUE_TEMPLATE/$template_file (differs)"
            fi
          done

          # Check documentation files
          for doc_file in "${SYNC_DOCS[@]}"; do
            source_file="workflows/templates/consumer-repo/docs/$doc_file"
            consumer_file="consumer/docs/$doc_file"

            if [ ! -f "$source_file" ]; then
              continue
            fi

            if [ ! -f "$consumer_file" ]; then
              changes="$changes docs/$doc_file"
              sync_report="$sync_report\n- docs/$doc_file (missing)"
            elif ! compare_files "$source_file" "$consumer_file" false; then
              changes="$changes docs/$doc_file"
              sync_report="$sync_report\n- docs/$doc_file (differs)"
            fi
          done

          # Check root config files
          for config_file in "${SYNC_ROOT_CONFIGS[@]}"; do
            source_file="workflows/templates/consumer-repo/$config_file"
            consumer_file="consumer/$config_file"

            if [ ! -f "$source_file" ]; then
              continue
            fi

            if [ ! -f "$consumer_file" ]; then
              changes="$changes $config_file"
              sync_report="$sync_report\n- $config_file (missing)"
            elif ! compare_files "$source_file" "$consumer_file" false; then
              changes="$changes $config_file"
              sync_report="$sync_report\n- $config_file (differs)"
            fi
          done

          # Check GitHub config files (PR template, etc.)
          for config_file in "${SYNC_GITHUB_CONFIG[@]}"; do
            source_file="workflows/templates/consumer-repo/.github/$config_file"
            consumer_file="consumer/.github/$config_file"

            if [ ! -f "$source_file" ]; then
              continue
            fi

            if [ ! -f "$consumer_file" ]; then
              changes="$changes .github/$config_file"
              sync_report="$sync_report\n- .github/$config_file (missing)"
            elif ! compare_files "$source_file" "$consumer_file" false; then
              changes="$changes .github/$config_file"
              sync_report="$sync_report\n- .github/$config_file (differs)"
            fi
          done

          if [ -n "$changes" ]; then
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "changed_files=$changes" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          fi

          echo -e "Sync report:$sync_report" >> "$GITHUB_STEP_SUMMARY"

      - name: Apply template updates
        if: steps.detect.outputs.has_changes == 'true' || inputs.force == true
        run: |
          set -euo pipefail

          cd consumer

          # Repos with custom Gate workflows that should NOT be overwritten
          CUSTOM_GATE_REPOS="stranske/trip-planner stranske/Manager-Database"
          CURRENT_REPO="${{ matrix.repo }}"

          # Sync thin caller workflow files from templates
          SYNC_TEMPLATES=(
            "agents-orchestrator.yml"
            "agents-pr-meta.yml"
            "agents-keepalive-loop.yml"
            "agents-verifier.yml"
            "autofix.yml"
            "pr-00-gate.yml"
          )

          for file in "${SYNC_TEMPLATES[@]}"; do
            # Skip pr-00-gate.yml for repos with custom Gate workflows
            if [ "$file" = "pr-00-gate.yml" ] && echo "$CUSTOM_GATE_REPOS" | grep -qw "$CURRENT_REPO"; then
              echo "Skipping $file for $CURRENT_REPO (has custom Gate workflow)"
              continue
            fi

            template="../workflows/templates/consumer-repo/.github/workflows/$file"

            # Find target file (may have numbered prefix)
            if [ -f ".github/workflows/$file" ]; then
              target=".github/workflows/$file"
            elif [ -f ".github/workflows/agents-70-orchestrator.yml" ] && [ "$file" = "agents-orchestrator.yml" ]; then
              target=".github/workflows/agents-70-orchestrator.yml"
            else
              # Create new file if it doesn't exist (for new workflows like keepalive-loop)
              mkdir -p .github/workflows
              target=".github/workflows/$file"
            fi

            if [ -f "$template" ]; then
              cp "$template" "$target"
            fi
          done

          # Sync full workflows from .github/workflows/ (not templates)
          FULL_WORKFLOWS=(
            "agents-63-issue-intake.yml"
          )

          for workflow in "${FULL_WORKFLOWS[@]}"; do
            source="../workflows/.github/workflows/$workflow"
            target=".github/workflows/$workflow"

            if [ -f "$source" ] && [ -f "$target" ]; then
              cp "$source" "$target"
            fi
          done

          # Sync scripts
          SYNC_SCRIPTS=(
            "decode_raw_input.py"
            "parse_chatgpt_topics.py"
            "fallback_split.py"
          )

          mkdir -p .github/scripts
          for script in "${SYNC_SCRIPTS[@]}"; do
            source="../workflows/.github/scripts/$script"
            target=".github/scripts/$script"

            if [ -f "$source" ]; then
              cp "$source" "$target"
            fi
          done

          # Sync codex prompts and instructions (required for keepalive)
          SYNC_CODEX_FILES=(
            "AGENT_INSTRUCTIONS.md"
            "prompts/keepalive_next_task.md"
          )

          mkdir -p .github/codex/prompts
          for codex_file in "${SYNC_CODEX_FILES[@]}"; do
            source="../workflows/templates/consumer-repo/.github/codex/$codex_file"
            target=".github/codex/$codex_file"

            if [ -f "$source" ]; then
              cp "$source" "$target"
            fi
          done

          # Sync issue templates (for agent automation)
          SYNC_ISSUE_TEMPLATES=(
            "agent_task.yml"
            "config.yml"
          )

          mkdir -p .github/ISSUE_TEMPLATE
          for template_file in "${SYNC_ISSUE_TEMPLATES[@]}"; do
            source="../workflows/templates/consumer-repo/.github/ISSUE_TEMPLATE/$template_file"
            target=".github/ISSUE_TEMPLATE/$template_file"

            if [ -f "$source" ]; then
              cp "$source" "$target"
            fi
          done

          # Sync documentation files (for LLM reference and user guidance)
          SYNC_DOCS=(
            "AGENT_ISSUE_FORMAT.md"
            "CI_SYSTEM_GUIDE.md"
            "LABELS.md"
          )

          mkdir -p docs
          for doc_file in "${SYNC_DOCS[@]}"; do
            source="../workflows/templates/consumer-repo/docs/$doc_file"
            target="docs/$doc_file"

            if [ -f "$source" ]; then
              cp "$source" "$target"
            fi
          done

          # Sync GitHub config files (PR template, etc.)
          SYNC_GITHUB_CONFIG=(
            "PULL_REQUEST_TEMPLATE.md"
          )

          for config_file in "${SYNC_GITHUB_CONFIG[@]}"; do
            source="../workflows/templates/consumer-repo/.github/$config_file"
            target=".github/$config_file"

            if [ -f "$source" ]; then
              cp "$source" "$target"
            fi
          done

          # Sync root config files
          SYNC_ROOT_CONFIGS=(
            ".gitignore"
          )

          for config_file in "${SYNC_ROOT_CONFIGS[@]}"; do
            source="../workflows/templates/consumer-repo/$config_file"
            target="$config_file"

            if [ -f "$source" ]; then
              # For .gitignore, merge rather than replace to preserve custom entries
              if [ "$config_file" = ".gitignore" ] && [ -f "$target" ]; then
                # Append any lines from source that aren't already in target
                while IFS= read -r line; do
                  if ! grep -qxF "$line" "$target" 2>/dev/null; then
                    echo "$line" >> "$target"
                  fi
                done < "$source"
              else
                cp "$source" "$target"
              fi
            fi
          done

          # NOTE: autofix-versions.env is NOT synced
          # Each consumer repo maintains its own dependency versions based on its lock files

      - name: Create sync PR
        if: (steps.detect.outputs.has_changes == 'true' || inputs.force == true) && inputs.dry_run != true
        env:
          GH_TOKEN: ${{ env.SYNC_TOKEN }}
        run: |
          set -euo pipefail

          cd consumer

          # Check if there are actual changes
          if git diff --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Create branch
          branch="sync/workflows-${{ needs.prepare.outputs.template_hash }}"
          git checkout -b "$branch"

          # Commit
          git add -A
          git commit -m "sync: Update workflow templates from stranske/Workflows

          Template hash: ${{ needs.prepare.outputs.template_hash }}

          This sync includes updates to thin caller workflows that delegate to
          reusable workflows in stranske/Workflows. No action required unless
          you have local customizations to preserve.

          Changed files: ${{ steps.detect.outputs.changed_files }}"

          # Push
          git push origin "$branch" --force

          # Create or update PR
          existing_pr=$(gh pr list --base main --head "$branch" --json number --jq '.[0].number // empty')

          if [ -n "$existing_pr" ]; then
            echo "Updated existing PR #$existing_pr"
          else
            gh pr create \
              --title "sync: Update workflow templates from stranske/Workflows" \
              --body "## Workflow Sync

              This PR updates thin caller workflows to match the latest templates from [stranske/Workflows](https://github.com/stranske/Workflows).

              **Template hash:** \`${{ needs.prepare.outputs.template_hash }}\`

              ### Changed files
              ${{ steps.detect.outputs.changed_files }}

              ### What changed
              - Thin caller workflows (triggers/permissions) updated
              - Tool version pins may be updated
              - No changes to your repo-specific code

              ### Review checklist
              - [ ] No repo-specific customizations were overwritten
              - [ ] CI passes with new workflow versions

              ---
              *Automated by [Maint 68 Sync Consumer Repos](https://github.com/stranske/Workflows/actions/workflows/maint-68-sync-consumer-repos.yml)*" \
              --label "sync,automation"
          fi

      - name: Dry run summary
        if: inputs.dry_run == true
        run: |
          echo "## Dry Run Results for ${{ matrix.repo }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          if [ "${{ steps.detect.outputs.has_changes }}" = "true" ]; then
            echo "✅ Changes detected:" >> "$GITHUB_STEP_SUMMARY"
            echo "${{ steps.detect.outputs.changed_files }}" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "ℹ️ No changes needed" >> "$GITHUB_STEP_SUMMARY"
          fi

  summary:
    name: Sync summary
    needs: [prepare, sync]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate summary
        run: |
          {
            echo "## Consumer Repo Sync Summary"
            echo ""
            echo "Template hash: \`${{ needs.prepare.outputs.template_hash }}\`"
            echo ""
            echo "See individual job results above for per-repo details."
          } >> "$GITHUB_STEP_SUMMARY"
