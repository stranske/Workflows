name: Maint 68 Sync Consumer Repos

# Push workflow template updates to registered consumer repositories
#
# ARCHITECTURE: This workflow is MANIFEST-DRIVEN
# All sync targets are declared in .github/sync-manifest.yml
# DO NOT add hardcoded file lists here - update the manifest instead
#
# Triggered after releases, template changes, or manually

on:
  release:
    types: [published]
  push:
    branches: [main]
    paths:
      - 'templates/consumer-repo/**'
      - '.github/sync-manifest.yml'
  workflow_dispatch:
    inputs:
      repos:
        description: 'Comma-separated repos to sync (empty for all registered)'
        type: string
        required: false
      dry_run:
        description: 'Preview changes without creating PRs'
        type: boolean
        default: false
      force:
        description: 'Force sync even if no changes detected'
        type: boolean
        default: false

permissions:
  contents: read

env:
  # Consumer repos registered for automatic sync
  REGISTERED_CONSUMER_REPOS: |
    stranske/Travel-Plan-Permission
    stranske/Template
    stranske/trip-planner
    stranske/Manager-Database

jobs:
  # ============================================================================
  # PREPARE: Load manifest and build repo matrix
  # ============================================================================
  prepare:
    name: Prepare sync from manifest
    runs-on: ubuntu-latest
    outputs:
      repos: ${{ steps.repos.outputs.matrix }}
      template_hash: ${{ steps.hash.outputs.hash }}
      manifest_json: ${{ steps.manifest.outputs.json }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            templates/consumer-repo
            .github/sync-manifest.yml
            .github/scripts
          sparse-checkout-cone-mode: false

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Load and validate manifest
        id: manifest
        run: |
          python3 << 'MANIFEST_SCRIPT'
          import yaml
          import json
          import os
          import sys

          manifest_path = '.github/sync-manifest.yml'
          if not os.path.exists(manifest_path):
              print("::error::sync-manifest.yml not found!")
              sys.exit(1)

          with open(manifest_path) as f:
              manifest = yaml.safe_load(f)

          # Validate required sections exist
          required_sections = ['workflows', 'prompts', 'scripts']
          for section in required_sections:
              if section not in manifest:
                  print(f"::warning::Manifest missing '{section}' section")
                  manifest[section] = []

          # Convert to JSON for workflow consumption
          manifest_json = json.dumps(manifest, separators=(',', ':'))

          # GitHub has output size limits, so we'll write to file too
          with open('manifest.json', 'w') as f:
              json.dump(manifest, f)

          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"json={manifest_json}\n")

          print(f"Loaded manifest with:")
          print(f"  - {len(manifest.get('workflows', []))} workflows")
          print(f"  - {len(manifest.get('prompts', []))} prompts")
          print(f"  - {len(manifest.get('scripts', []))} scripts")
          print(f"  - {len(manifest.get('codex_config', []))} codex configs")
          print(f"  - {len(manifest.get('docs', []))} docs")
          MANIFEST_SCRIPT

      - name: Compute template hash
        id: hash
        run: |
          hash=$(find templates/consumer-repo -type f -exec sha256sum {} \; | sort | sha256sum | cut -d' ' -f1)
          echo "hash=${hash:0:12}" >> "$GITHUB_OUTPUT"
          echo "Template hash: ${hash:0:12}"

      - name: Build repo matrix
        id: repos
        run: |
          if [ -n "${{ inputs.repos }}" ]; then
            repos='${{ inputs.repos }}'
          else
            repos=$(echo "$REGISTERED_CONSUMER_REPOS" | tr '\n' ',' | sed 's/,$//')
          fi
          json_array=$(echo "$repos" | tr ',' '\n' | grep -v '^$' | jq -R -s -c 'split("\n") | map(select(. != "")) | map(gsub("^\\s+|\\s+$"; ""))')
          echo "matrix={\"repo\":$json_array}" >> "$GITHUB_OUTPUT"
          echo "Repos to sync: $json_array"

      - name: Upload manifest artifact
        uses: actions/upload-artifact@v4
        with:
          name: sync-manifest
          path: manifest.json
          retention-days: 1

  # ============================================================================
  # VALIDATE: Ensure files pass lint before syncing
  # ============================================================================
  validate:
    name: Validate sync files
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install lint tools
        run: pip install ruff pyyaml

      - name: Download manifest
        uses: actions/download-artifact@v4
        with:
          name: sync-manifest

      - name: Validate Python scripts
        run: |
          set -euo pipefail

          # Read scripts from manifest
          scripts=$(python3 -c "
          import json
          with open('manifest.json') as f:
              m = json.load(f)
          for s in m.get('scripts', []):
              src = s.get('source', '')
              if src.endswith('.py'):
                  print(src)
          ")

          failed=0
          for script in $scripts; do
            if [ -f "$script" ]; then
              echo "Checking $script..."
              if ! ruff check --select="E,W,F,I,B" "$script"; then
                echo "::error::$script fails lint"
                failed=1
              fi
            fi
          done

          if [ "$failed" -eq 1 ]; then
            exit 1
          fi
          echo "✓ All Python scripts pass lint"

      - name: Validate YAML syntax
        run: |
          set -euo pipefail

          # Read workflows from manifest
          workflows=$(python3 -c "
          import json
          with open('manifest.json') as f:
              m = json.load(f)
          for w in m.get('workflows', []):
              src = w.get('source', '')
              if src.endswith('.yml') or src.endswith('.yaml'):
                  print(src)
          ")

          for workflow in $workflows; do
            template_path="templates/consumer-repo/$workflow"
            if [ -f "$template_path" ]; then
              echo "Validating $template_path..."
              python3 -c "import yaml; yaml.safe_load(open('$template_path'))"
            fi
          done
          echo "✓ All workflow YAML is valid"

  # ============================================================================
  # SYNC: Apply template to each consumer repo
  # ============================================================================
  sync:
    name: Sync ${{ matrix.repo }}
    needs: [prepare, validate]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare.outputs.repos) }}
    env:
      # Job-level alias for repo token (uses OWNER_PR_PAT or SERVICE_BOT_PAT)
      REPO_TOKEN: ${{ secrets.OWNER_PR_PAT || secrets.SERVICE_BOT_PAT }}
    steps:
      - name: Checkout Workflows
        uses: actions/checkout@v4
        with:
          path: workflows

      - name: Clone consumer repo
        env:
          GH_TOKEN: ${{ env.REPO_TOKEN }}
        run: |
          gh repo clone ${{ matrix.repo }} consumer -- --depth=1

      - name: Download manifest
        uses: actions/download-artifact@v4
        with:
          name: sync-manifest

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Detect and apply changes
        id: sync
        env:
          CURRENT_REPO: ${{ matrix.repo }}
          DRY_RUN: ${{ inputs.dry_run }}
          FORCE: ${{ inputs.force }}
        run: |
          python3 << 'SYNC_SCRIPT'
          import json
          import os
          import shutil
          import subprocess
          from pathlib import Path

          # Load manifest
          with open('manifest.json') as f:
              manifest = json.load(f)

          current_repo = os.environ.get('CURRENT_REPO', '')
          dry_run = os.environ.get('DRY_RUN', 'false') == 'true'
          force = os.environ.get('FORCE', 'false') == 'true'

          # Repos with custom Gate workflows
          custom_gate_repos = ['stranske/trip-planner', 'stranske/Manager-Database']

          changes = []
          skipped = []

          def files_differ(src, dst):
              """Compare files, ignoring header comments (first 10 lines)."""
              if not dst.exists():
                  return True
              if not src.exists():
                  return False

              src_lines = src.read_text().splitlines()
              dst_lines = dst.read_text().splitlines()

              # For short files, compare everything
              if len(src_lines) < 15 or len(dst_lines) < 15:
                  return src_lines != dst_lines

              # Skip header (first 10 lines) for comparison
              return src_lines[10:] != dst_lines[10:]

          def sync_file(source_path, target_path, description, skip_condition=None):
              """Sync a single file from template to consumer."""
              src = Path(source_path)
              dst = Path(target_path)

              if skip_condition and skip_condition():
                  skipped.append(f"{dst.name}: {skip_condition.__doc__}")
                  return False

              if not src.exists():
                  print(f"  ⚠ Source missing: {src}")
                  return False

              if force or files_differ(src, dst):
                  if not dry_run:
                      dst.parent.mkdir(parents=True, exist_ok=True)
                      shutil.copy2(src, dst)
                  changes.append(f"{dst.name}: {description}")
                  return True
              return False

          def sync_directory(source_path, target_path, description):
              """Sync an entire directory from template to consumer."""
              src = Path(source_path)
              dst = Path(target_path)

              if not src.exists() or not src.is_dir():
                  print(f"  ⚠ Source directory missing: {src}")
                  return False

              dir_changes = []
              for src_file in src.rglob('*'):
                  if src_file.is_file():
                      rel_path = src_file.relative_to(src)
                      dst_file = dst / rel_path
                      if force or files_differ(src_file, dst_file):
                          if not dry_run:
                              dst_file.parent.mkdir(parents=True, exist_ok=True)
                              shutil.copy2(src_file, dst_file)
                          dir_changes.append(str(rel_path))

              if dir_changes:
                  changes.append(f"{dst.name}/ ({len(dir_changes)} files): {description}")
              return len(dir_changes) > 0

          # Process workflows
          print("Processing workflows...")
          for item in manifest.get('workflows', []):
              source = item.get('source', '')
              description = item.get('description', 'No description')
              sync_mode = item.get('sync_mode', 'sync')

              # Build paths
              template_src = Path('workflows/templates/consumer-repo') / source
              consumer_dst = Path('consumer') / source

              # Skip conditions
              def skip_custom_gate():
                  """Repo has custom Gate workflow"""
                  return 'pr-00-gate' in source and current_repo in custom_gate_repos

              def skip_create_only():
                  """File exists and sync_mode is create_only"""
                  return sync_mode == 'create_only' and consumer_dst.exists()

              skip_fn = None
              if 'pr-00-gate' in source:
                  skip_fn = skip_custom_gate
              elif sync_mode == 'create_only':
                  skip_fn = skip_create_only

              sync_file(template_src, consumer_dst, description, skip_fn)

          # Process prompts
          print("Processing prompts...")
          for item in manifest.get('prompts', []):
              source = item.get('source', '')
              description = item.get('description', 'No description')
              template_src = Path('workflows/templates/consumer-repo') / source
              consumer_dst = Path('consumer') / source
              sync_file(template_src, consumer_dst, description)

          # Process scripts
          print("Processing scripts...")
          for item in manifest.get('scripts', []):
              source = item.get('source', '')
              description = item.get('description', 'No description')
              # Scripts come from .github/scripts/, not templates
              template_src = Path('workflows') / source
              consumer_dst = Path('consumer') / source
              sync_file(template_src, consumer_dst, description)

          # Process codex_config
          print("Processing codex config...")
          for item in manifest.get('codex_config', []):
              source = item.get('source', '')
              description = item.get('description', 'No description')
              template_src = Path('workflows/templates/consumer-repo') / source
              consumer_dst = Path('consumer') / source
              sync_file(template_src, consumer_dst, description)


          # Process copilot_config
          print("Processing copilot config...")
          for item in manifest.get('copilot_config', []):
              source = item.get('source', '')
              description = item.get('description', 'No description')
              is_directory = item.get('is_directory', False)
              template_src = Path('workflows/templates/consumer-repo') / source
              consumer_dst = Path('consumer') / source

              if is_directory:
                  sync_directory(template_src, consumer_dst, description)
              else:
                  sync_file(template_src, consumer_dst, description)
          # Process docs
          print("Processing docs...")
          for item in manifest.get('docs', []):
              source = item.get('source', '')
              target = item.get('target', source)
              description = item.get('description', 'No description')
              template_src = Path('workflows/templates/consumer-repo') / source
              consumer_dst = Path('consumer') / target
              sync_file(template_src, consumer_dst, description)

          # Output results
          print(f"\n{'='*60}")
          print(f"SYNC RESULTS for {current_repo}")
          print(f"{'='*60}")

          if changes:
              print(f"\n✓ {len(changes)} files to sync:")
              for c in changes:
                  print(f"  - {c}")
          else:
              print("\n✓ No changes needed")

          if skipped:
              print(f"\n⊘ {len(skipped)} files skipped:")
              for s in skipped:
                  print(f"  - {s}")

          # Set outputs
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"changes_count={len(changes)}\n")
              f.write(f"has_changes={'true' if changes else 'false'}\n")

          # Write change summary for PR body
          with open('sync_summary.md', 'w') as f:
              f.write("## Sync Summary\n\n")
              if changes:
                  f.write("### Files Updated\n")
                  for c in changes:
                      f.write(f"- {c}\n")
              if skipped:
                  f.write("\n### Files Skipped\n")
                  for s in skipped:
                      f.write(f"- {s}\n")
          SYNC_SCRIPT

      - name: Check for required labels
        if: steps.sync.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ env.REPO_TOKEN }}
        run: |
          cd consumer

          # Required labels for sync PRs
          required_labels=("sync" "automated")

          for label in "${required_labels[@]}"; do
            if ! gh label list --json name -q ".[].name" | grep -q "^${label}$"; then
              echo "Creating label: $label"
              gh label create "$label" --description "Automated sync from Workflows" --color "0e8a16" || true
            fi
          done

      - name: Create sync PR
        if: steps.sync.outputs.has_changes == 'true' && inputs.dry_run != true
        env:
          GH_TOKEN: ${{ env.REPO_TOKEN }}
        run: |
          cd consumer

          branch_name="sync/workflows-${{ needs.prepare.outputs.template_hash }}"

          # Check if branch/PR already exists
          existing_pr=$(gh pr list --head "$branch_name" --json number -q '.[0].number' || echo "")
          if [ -n "$existing_pr" ]; then
            echo "PR #$existing_pr already exists for this sync"
            echo "::notice::Existing PR: #$existing_pr"
            exit 0
          fi

          # Configure git for push authentication using credential helper
          # This avoids exposing token in git remote URL or command output
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          # shellcheck disable=SC2016 # Single quotes intentional - ${GH_TOKEN} expands at runtime in credential helper
          git config credential.helper '!f() { echo "username=x-access-token"; echo "password=${GH_TOKEN}"; }; f'

          # Create branch and commit
          git checkout -b "$branch_name"
          git add -A
          git commit -m "chore: sync workflow templates from Workflows repo

          Automated sync from stranske/Workflows
          Template hash: ${{ needs.prepare.outputs.template_hash }}

          Changes synced from sync-manifest.yml"

          git push --quiet -u origin "$branch_name"

          # Create PR
          pr_body=$(cat ../sync_summary.md)
          pr_body="$pr_body

          ---

          ### Review Checklist
          - [ ] CI passes with updated workflows
          - [ ] No repo-specific customizations were overwritten

          **Source:** [stranske/Workflows](https://github.com/stranske/Workflows)
          **Manifest:** [\`.github/sync-manifest.yml\`](https://github.com/stranske/Workflows/blob/main/.github/sync-manifest.yml)"

          gh pr create \
            --title "chore: sync workflow templates" \
            --body "$pr_body" \
            --label "sync,automated"

      - name: Dry run summary
        if: inputs.dry_run == true
        run: |
          {
            echo "## Dry Run Summary"
            echo ""
            echo "**Repo:** ${{ matrix.repo }}"
            echo "**Changes:** ${{ steps.sync.outputs.changes_count }}"
            echo ""
            cat sync_summary.md
          } >> "$GITHUB_STEP_SUMMARY"

  # ============================================================================
  # SUMMARY: Generate overall sync report
  # ============================================================================
  summary:
    name: Generate summary
    needs: [prepare, sync]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate summary
        run: |
          {
            echo "## Consumer Repo Sync Summary"
            echo ""
            echo "**Template Hash:** ${{ needs.prepare.outputs.template_hash }}"
            echo "**Dry Run:** ${{ inputs.dry_run || 'false' }}"
            echo ""
            echo "### Repos Processed"
            echo '${{ needs.prepare.outputs.repos }}' | jq -r '.repo[]' | while read -r repo; do
              echo "- $repo"
            done
            echo ""
            echo "---"
            echo "*Sync driven by [sync-manifest.yml](https://github.com/stranske/Workflows/blob/main/.github/sync-manifest.yml)*"
          } >> "$GITHUB_STEP_SUMMARY"
