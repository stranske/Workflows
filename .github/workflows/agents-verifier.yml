name: Agents Verifier

on:
  pull_request:
    types:
      - closed
  push:
    branches:
      - main

permissions:
  contents: read
  pull-requests: read
  issues: write

jobs:
  verifier:
    name: Run post-merge verifier
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build verifier context
        id: context
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { buildVerifierContext } = require('./.github/scripts/agents_verifier_context.js');
            await buildVerifierContext({ github, context, core });

      - name: Stop when verifier is skipped
        if: steps.context.outputs.should_run != 'true'
        run: |
          echo "Verifier skipped: ${{ steps.context.outputs.skip_reason || 'no reason provided' }}"

      - name: Prepare verifier prompt
        if: steps.context.outputs.should_run == 'true'
        id: prepare
        run: |
          set -euo pipefail
          base_prompt=".github/codex/prompts/verifier_acceptance_check.md"
          context_file="${{ steps.context.outputs.context_path }}"
          combined="verifier-prompt.md"
          if [ ! -f "$base_prompt" ]; then
            echo "::error::Base prompt file missing: $base_prompt"
            exit 1
          fi
          if [ ! -f "$context_file" ]; then
            echo "::error::Context file missing: $context_file"
            exit 1
          fi
          {
            cat "$base_prompt"
            printf '\n\n---\n\n'
            cat "$context_file"
          } > "$combined"
          echo "prompt_file=$combined" >> "$GITHUB_OUTPUT"

      - name: Setup Codex auth
        if: steps.context.outputs.should_run == 'true'
        env:
          CODEX_AUTH_JSON: ${{ secrets.CODEX_AUTH_JSON }}
        run: |
          set -euo pipefail
          mkdir -p ~/.codex
          echo "$CODEX_AUTH_JSON" > ~/.codex/auth.json
          chmod 600 ~/.codex/auth.json
          echo "Codex auth configured from CODEX_AUTH_JSON secret"

      - name: Run verifier
        id: codex
        if: steps.context.outputs.should_run == 'true'
        uses: openai/codex-action@v1
        with:
          # Auth is pre-configured via ~/.codex/auth.json from CODEX_AUTH_JSON secret
          openai-api-key: 'auth-via-codex-auth-json'
          prompt-file: ${{ steps.prepare.outputs.prompt_file }}
          output-file: codex-output.md
          sandbox: read-only
          safety-strategy: drop-sudo
          codex-args: --mode verifier

      - name: Parse verifier verdict
        id: verdict
        if: steps.context.outputs.should_run == 'true'
        run: |
          set -euo pipefail
          verdict="unknown"
          output_file="codex-output.md"
          if [ -f "$output_file" ]; then
            if grep -qiE 'verdict:\\s*fail' "$output_file"; then
              verdict="fail"
            elif grep -qiE 'verdict:\\s*pass' "$output_file"; then
              verdict="pass"
            fi
          fi
          echo "verdict=$verdict" >> "$GITHUB_OUTPUT"

      - name: Open follow-up issue on verifier failure
        if: steps.context.outputs.should_run == 'true' && steps.verdict.outputs.verdict == 'fail'
        id: failure_issue
        uses: actions/github-script@v7
        env:
          PR_URL: ${{ steps.context.outputs.pr_html_url }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = Number('${{ steps.context.outputs.pr_number }}') || null;
            const issueNumbers = JSON.parse('${{ steps.context.outputs.issue_numbers || '[]' }}');
            const title = prNumber
              ? `Verifier failure for PR #${prNumber}`
              : 'Verifier failure on merged commit';
            const lines = [];
            if (process.env.PR_URL) {
              lines.push(`Source pull request: ${process.env.PR_URL}`);
            }
            if (Array.isArray(issueNumbers) && issueNumbers.length) {
              lines.push(`Linked issues: ${issueNumbers.map((n) => `#${n}`).join(', ')}`);
            }
            lines.push('');
            lines.push('## Verifier output');
            lines.push('');
            lines.push('```');
            lines.push(require('fs').readFileSync('codex-output.md', 'utf8'));
            lines.push('```');
            lines.push('');
            lines.push('- [ ] Re-run verifier after addressing the failures.');
            const body = lines.join('\n');
            await github.rest.issues.create({
              ...context.repo,
              title,
              body,
              labels: ['agent:codex'],
            });
            core?.setOutput('created', '1');

      - name: Emit verifier metrics
        if: steps.context.outputs.should_run == 'true'
        env:
          PR_NUMBER: ${{ steps.context.outputs.pr_number }}
          VERDICT: ${{ steps.verdict.outputs.verdict }}
          ACCEPTANCE_COUNT: ${{ steps.context.outputs.acceptance_count }}
          ISSUE_CREATED: ${{ steps.failure_issue.outputs.created }}
        run: |
          set -euo pipefail
          pr_number="${PR_NUMBER:-0}"
          verdict="${VERDICT:-unknown}"
          acceptance_count="${ACCEPTANCE_COUNT:-0}"
          issue_created="${ISSUE_CREATED:-0}"

          if ! [[ "$acceptance_count" =~ ^[0-9]+$ ]]; then
            acceptance_count=0
          fi

          if ! [[ "$issue_created" =~ ^[0-9]+$ ]]; then
            issue_created=0
          fi

          checks_run=$acceptance_count
          if [ "$checks_run" -lt 1 ]; then
            checks_run=1
          fi

          metrics_json=$(jq -n \
            --arg pr "$pr_number" \
            --arg verdict "$verdict" \
            --arg issues_created "$issue_created" \
            --arg acceptance "$acceptance_count" \
            --arg checks "$checks_run" \
            '{
              pr_number: ($pr | tonumber? // 0),
              verdict: $verdict,
              issues_created: ($issues_created | tonumber? // 0),
              acceptance_criteria_count: ($acceptance | tonumber? // 0),
              checks_run: ($checks | tonumber? // 0)
            }')

          {
            echo '### Verifier metrics'
            echo ''
            echo '| Field | Value |'
            echo '| --- | --- |'
            echo "| pr_number | $(echo "$metrics_json" | jq -r '.pr_number') |"
            echo "| verdict | $(echo "$metrics_json" | jq -r '.verdict') |"
            echo "| issues_created | $(echo "$metrics_json" | jq -r '.issues_created') |"
            echo "| acceptance_criteria_count | $(echo "$metrics_json" | jq -r '.acceptance_criteria_count') |"
            echo "| checks_run | $(echo "$metrics_json" | jq -r '.checks_run') |"
          } >> "$GITHUB_STEP_SUMMARY"

          echo "$metrics_json" >> verifier-metrics.ndjson

      - name: Upload verifier metrics artifact
        if: steps.context.outputs.should_run == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: verifier-metrics
          path: verifier-metrics.ndjson
          retention-days: 30
          if-no-files-found: error
