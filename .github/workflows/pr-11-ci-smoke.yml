name: PR 11 - Minimal invariant CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

jobs:
  smoke:
    name: YAML syntax + script imports
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1  # Shallow clone for faster checkout

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: pip
          cache-dependency-path: pyproject.toml

      - name: Install minimal dependencies
        run: |
          pip install pyyaml

      - name: Validate workflow YAML syntax
        run: |
          python - <<'PY'
          import yaml
          from pathlib import Path

          errors = []
          for f in Path('.github/workflows').glob('*.yml'):
              try:
                  yaml.safe_load(f.read_text())
                  print(f"✓ {f.name}")
              except yaml.YAMLError as e:
                  errors.append(f'{f}: {e}')
                  print(f"✗ {f.name}: {e}")

          if errors:
              raise SystemExit(f"Found {len(errors)} YAML syntax errors")
          print(f"\nAll workflow files valid")
          PY

      - name: Sanity check script imports
        run: |
          python - <<'PY'
          import importlib.util
          from pathlib import Path

          scripts_dir = Path('scripts')
          errors = []
          for script in scripts_dir.glob('*.py'):
              if script.name.startswith('_'):
                  continue
              try:
                  spec = importlib.util.spec_from_file_location(script.stem, script)
                  if spec and spec.loader:
                      module = importlib.util.module_from_spec(spec)
                      # Don't actually execute, just check syntax
                      compile(script.read_text(), script, 'exec')
                      print(f"✓ {script.name}")
              except SyntaxError as e:
                  errors.append(f'{script}: {e}')
                  print(f"✗ {script.name}: {e}")

          if errors:
              raise SystemExit(f"Found {len(errors)} syntax errors in scripts")
          print(f"\nAll scripts have valid syntax")
          PY
