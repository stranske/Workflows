name: Selftest CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test-javascript:
    name: JavaScript Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run JavaScript tests
        run: node --test .github/scripts/__tests__/*.test.js

  test-python:
    name: Python Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: pip
          cache-dependency-path: pyproject.toml

      - name: Install dependencies
        run: |
          pip install pytest pytest-cov pyyaml requests numpy pandas

      - name: Run Python tests
        run: |
          python -m pytest tests/workflows/ -v

  lint-and-validate:
    name: Lint, Format & YAML Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: pip
          cache-dependency-path: pyproject.toml

      - name: Install tools
        run: pip install black ruff pyyaml

      - name: Check Black formatting
        run: black --check .

      - name: Run Ruff linting
        run: ruff check .

      - name: Validate workflow YAML files
        run: |
          python -c "
          import yaml
          import sys
          from pathlib import Path

          errors = []
          for f in Path('.github/workflows').glob('*.yml'):
              try:
                  yaml.safe_load(f.read_text())
              except yaml.YAMLError as e:
                  errors.append(f'{f}: {e}')

          if errors:
              for e in errors:
                  print(e, file=sys.stderr)
              sys.exit(1)
          print(f'Validated {len(list(Path(\".github/workflows\").glob(\"*.yml\")))} workflow files')
          "
