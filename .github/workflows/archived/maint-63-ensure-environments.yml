name: Maint 63 Ensure Agent Environments

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  deployments: write
  pull-requests: read

jobs:
  sync-environments:
    name: Sync agent environments
    runs-on: ubuntu-latest
    steps:
      - name: Ensure environments exist with protections
        uses: actions/github-script@v8
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            async function resolveMaintainersReviewer() {
              try {
                const { data } = await github.rest.teams.getByName({
                  org: owner,
                  team_slug: 'maintainers',
                });
                if (data?.id) {
                  return [{ type: 'Team', id: data.id }];
                }
              } catch (error) {
                const status = error?.status || error?.response?.status;
                if (status === 404) {
                  core.warning('Team "maintainers" not found; falling back to repository owner as reviewer.');
                } else {
                  throw error;
                }
              }

              const { data: user } = await github.rest.users.getByUsername({ username: owner });
              if (!user?.id) {
                throw new Error('Unable to resolve fallback reviewer for agent-high-privilege.');
              }
              return [{ type: 'User', id: user.id }];
            }

            async function upsertEnvironment({ name, reviewers }) {
              await github.rest.repos.createOrUpdateEnvironment({
                owner,
                repo,
                environment_name: name,
                reviewers,
                wait_timer: 0,
                deployment_branch_policy: {
                  protected_branches: false,
                  custom_branch_policies: false,
                },
              });
              core.info(`Environment ${name} synced (reviewers: ${reviewers.map(r => r.type).join(', ') || 'none'}).`);
            }

            const environments = [
              { name: 'agent-standard', reviewers: [] },
              { name: 'agent-high-privilege', reviewers: await resolveMaintainersReviewer() },
            ];

            for (const env of environments) {
              await upsertEnvironment(env);
            }
