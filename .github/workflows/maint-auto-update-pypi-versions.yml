# Auto-update dev tool versions from PyPI
#
# This workflow ensures autofix-versions.env stays current with PyPI releases.
# It runs daily and creates a PR if any versions are outdated.
#
# CRITICAL: This workflow MUST run before maint-52-sync-dev-versions.yml
# to ensure we never ship stale versions to consumer repos.

name: Maint Auto-Update PyPI Versions

on:
  schedule:
    # Daily at 03:00 UTC (before the weekly sync at 05:00)
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Preview changes without creating PR'
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

jobs:
  check-and-update:
    name: Check PyPI for updates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Workflows
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Check for outdated versions
        id: check
        run: |
          echo "üîç Checking PyPI for latest versions..."
          if python scripts/update_versions_from_pypi.py --check 2>&1 | tee /tmp/check_output.txt; then
            echo "has_updates=false" >> "$GITHUB_OUTPUT"
          else
            # Check exits with 0 even for outdated (use --fail-on-outdated for non-zero)
            if grep -q "outdated" /tmp/check_output.txt; then
              echo "has_updates=true" >> "$GITHUB_OUTPUT"
            else
              echo "has_updates=false" >> "$GITHUB_OUTPUT"
            fi
          fi
          cat /tmp/check_output.txt

      - name: Update versions
        id: update
        if: steps.check.outputs.has_updates == 'true' && inputs.dry_run != true
        run: |
          echo "üì¶ Updating autofix-versions.env with latest PyPI versions..."
          python scripts/update_versions_from_pypi.py --apply 2>&1 | tee /tmp/update_output.txt

          # Extract update summary for PR body
          {
            echo "summary<<EOF"
            cat /tmp/update_output.txt
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create PR
        if: steps.check.outputs.has_updates == 'true' && inputs.dry_run != true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if there are actual changes
          if git diff --quiet .github/workflows/autofix-versions.env; then
            echo "No changes to commit"
            exit 0
          fi

          # Create branch
          branch="auto/update-pypi-versions-$(date +%Y%m%d)"
          git checkout -b "$branch"

          # Commit changes
          git add .github/workflows/autofix-versions.env
          git commit -m "chore: update dev tool versions from PyPI

          Auto-generated by maint-auto-update-pypi-versions workflow.

          ${{ steps.update.outputs.summary }}"

          # Push and create PR
          git push origin "$branch"

          gh pr create \
            --title "chore: update dev tool versions from PyPI" \
            --body "## Summary

          This PR updates the pinned dev tool versions in \`autofix-versions.env\` to match the latest releases on PyPI.

          ### Changes
          \`\`\`
          ${{ steps.update.outputs.summary }}
          \`\`\`

          ### Why this matters
          Keeping dev tool versions current ensures:
          - Consumer repos receive the latest bug fixes and features
          - We don't ship known-vulnerable or outdated tooling
          - Version drift between repos is minimized

          ---
          *Auto-generated by the [maint-auto-update-pypi-versions](.github/workflows/maint-auto-update-pypi-versions.yml) workflow*" \
            --label "dependencies" \
            --label "automation"

      - name: Dry run summary
        if: inputs.dry_run == true
        run: |
          echo "üîç Dry run - would have made these updates:"
          python scripts/update_versions_from_pypi.py --check
