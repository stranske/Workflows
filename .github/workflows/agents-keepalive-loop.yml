name: Agents Keepalive Loop

on:
  workflow_run:
    workflows: ["Gate"]
    types: [completed]
  pull_request:
    types:
      - labeled

permissions:
  contents: write
  pull-requests: write
  actions: write

concurrency:
  group: keepalive-${{ github.event.workflow_run.pull_requests[0].number || github.event.pull_request.number || github.run_id }}
  cancel-in-progress: false

jobs:
  evaluate:
    name: Evaluate keepalive loop
    runs-on: ubuntu-latest
    environment: agent-standard
    outputs:
      pr_number: ${{ steps.evaluate.outputs.pr_number }}
      action: ${{ steps.evaluate.outputs.action }}
      reason: ${{ steps.evaluate.outputs.reason }}
      gate_conclusion: ${{ steps.evaluate.outputs.gate_conclusion }}
      iteration: ${{ steps.evaluate.outputs.iteration }}
      max_iterations: ${{ steps.evaluate.outputs.max_iterations }}
      failure_threshold: ${{ steps.evaluate.outputs.failure_threshold }}
      tasks_total: ${{ steps.evaluate.outputs.tasks_total }}
      tasks_unchecked: ${{ steps.evaluate.outputs.tasks_unchecked }}
      keepalive_enabled: ${{ steps.evaluate.outputs.keepalive_enabled }}
      autofix_enabled: ${{ steps.evaluate.outputs.autofix_enabled }}
      has_agent_label: ${{ steps.evaluate.outputs.has_agent_label }}
      trace: ${{ steps.evaluate.outputs.trace }}
      security_blocked: ${{ steps.security_gate.outputs.blocked }}
      security_reason: ${{ steps.security_gate.outputs.reason }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Security gate - prompt injection guard
        id: security_gate
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { evaluatePromptInjectionGuard } = require('./.github/scripts/prompt_injection_guard.js');

            // Resolve PR from event context
            const payload = context.payload || {};
            let prNumber = 0;
            let pr = null;

            if (context.eventName === 'pull_request' && payload.pull_request) {
              prNumber = payload.pull_request.number;
              pr = payload.pull_request;
            } else if (context.eventName === 'workflow_run' && payload.workflow_run) {
              const prs = payload.workflow_run.pull_requests || [];
              if (prs[0]?.number) {
                prNumber = prs[0].number;
                const { data } = await github.rest.pulls.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber,
                });
                pr = data;
              }
            }

            if (!pr) {
              core.setOutput('blocked', 'false');
              core.setOutput('reason', 'no-pr-context');
              return;
            }

            const result = await evaluatePromptInjectionGuard({
              github,
              context,
              pr,
              actor: context.actor,
              promptContent: pr.body || '',
              core,
            });

            core.setOutput('blocked', String(result.blocked));
            core.setOutput('reason', result.reason);

            if (result.blocked) {
              core.setFailed(`Security gate blocked: ${result.reason}`);
            }

      - name: Evaluate keepalive state
        id: evaluate
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { evaluateKeepaliveLoop } = require('./.github/scripts/keepalive_loop.js');
            const result = await evaluateKeepaliveLoop({ github, context, core });
            const output = {
              pr_number: String(result.prNumber || ''),
              action: result.action || '',
              reason: result.reason || '',
              gate_conclusion: result.gateConclusion || '',
              iteration: String(result.iteration ?? ''),
              max_iterations: String(result.maxIterations ?? ''),
              failure_threshold: String(result.failureThreshold ?? ''),
              tasks_total: String(result.checkboxCounts?.total ?? ''),
              tasks_unchecked: String(result.checkboxCounts?.unchecked ?? ''),
              keepalive_enabled: String(result.keepaliveEnabled ?? ''),
              autofix_enabled: String(result.config?.autofix_enabled ?? ''),
              has_agent_label: String(result.hasAgentLabel ?? ''),
              trace: String(result.config?.trace || result.state?.trace || ''),
            };
            for (const [key, value] of Object.entries(output)) {
              core.setOutput(key, value);
            }

  preflight:
    name: Verify secrets available
    needs: evaluate
    if: needs.evaluate.outputs.action == 'run'
    runs-on: ubuntu-latest
    environment: agent-standard
    outputs:
      secrets_ok: ${{ steps.check.outputs.secrets_ok }}
    steps:
      - name: Check secrets
        id: check
        env:
          HAS_CODEX_AUTH: ${{ secrets.CODEX_AUTH_JSON != '' }}
          HAS_APP_ID: ${{ secrets.WORKFLOWS_APP_ID != '' }}
          HAS_APP_KEY: ${{ secrets.WORKFLOWS_APP_PRIVATE_KEY != '' }}
        run: |
          echo "CODEX_AUTH_JSON present: $HAS_CODEX_AUTH"
          echo "WORKFLOWS_APP_ID present: $HAS_APP_ID"
          echo "WORKFLOWS_APP_PRIVATE_KEY present: $HAS_APP_KEY"
          if [ "$HAS_CODEX_AUTH" = "true" ] || [ "$HAS_APP_ID" = "true" ]; then
            echo "secrets_ok=true" >> "$GITHUB_OUTPUT"
          else
            echo "::error::Neither CODEX_AUTH_JSON nor WORKFLOWS_APP_ID is set. Cannot run Codex."
            echo "secrets_ok=false" >> "$GITHUB_OUTPUT"
            exit 1
          fi

  run-codex:
    name: Keepalive next task
    needs:
      - evaluate
      - preflight
    if: needs.evaluate.outputs.action == 'run' && needs.preflight.outputs.secrets_ok == 'true'
    uses: ./.github/workflows/reusable-codex-run.yml
    secrets:
      CODEX_AUTH_JSON: ${{ secrets.CODEX_AUTH_JSON }}
      WORKFLOWS_APP_ID: ${{ secrets.WORKFLOWS_APP_ID }}
      WORKFLOWS_APP_PRIVATE_KEY: ${{ secrets.WORKFLOWS_APP_PRIVATE_KEY }}
    with:
      prompt_file: .github/codex/prompts/keepalive_next_task.md
      mode: keepalive
      pr_number: ${{ needs.evaluate.outputs.pr_number }}
    concurrency:
      group: keepalive-${{ needs.evaluate.outputs.pr_number }}
      cancel-in-progress: false

  summary:
    name: Update keepalive summary
    needs:
      - evaluate
      - preflight
      - run-codex
    if: always() && needs.evaluate.outputs.pr_number != '' && needs.evaluate.outputs.pr_number != '0'
    runs-on: ubuntu-latest
    environment: agent-standard
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update summary comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { updateKeepaliveLoopSummary } = require('./.github/scripts/keepalive_loop.js');
            const inputs = {
              pr_number: Number('${{ needs.evaluate.outputs.pr_number }}') || 0,
              action: '${{ needs.evaluate.outputs.action }}',
              reason: '${{ needs.evaluate.outputs.reason }}',
              gate_conclusion: '${{ needs.evaluate.outputs.gate_conclusion }}',
              iteration: Number('${{ needs.evaluate.outputs.iteration }}') || 0,
              max_iterations: Number('${{ needs.evaluate.outputs.max_iterations }}') || 0,
              failure_threshold: Number('${{ needs.evaluate.outputs.failure_threshold }}') || 3,
              tasks_total: Number('${{ needs.evaluate.outputs.tasks_total }}') || 0,
              tasks_unchecked: Number('${{ needs.evaluate.outputs.tasks_unchecked }}') || 0,
              keepalive_enabled: '${{ needs.evaluate.outputs.keepalive_enabled }}',
              autofix_enabled: '${{ needs.evaluate.outputs.autofix_enabled }}',
              trace: '${{ needs.evaluate.outputs.trace }}',
              run_result: '${{ needs.run-codex.result }}',
            };
            await updateKeepaliveLoopSummary({ github, context, core, inputs });
