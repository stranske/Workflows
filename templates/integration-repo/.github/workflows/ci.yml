name: Integration CI

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 4 * * *"
  workflow_dispatch:
    inputs:
      workflow_library_ref:
        description: "Ref of stranske/Workflows to validate"
        required: false
        default: "main"
  repository_dispatch:
    types: [workflow-library-release]

env:
  WORKFLOW_LIBRARY_REF: ${{ inputs.workflow_library_ref || github.event.client_payload.workflow_library_ref || 'main' }}

jobs:
  ci-basic:
    name: Basic
    uses: stranske/Workflows/.github/workflows/reusable-10-ci-python.yml@main
    with:
      python-version: "3.11"
      lint: true
      format_check: true
      typecheck: true
      coverage: false
      marker: ""
      working-directory: .

  ci-coverage:
    name: Full coverage
    uses: stranske/Workflows/.github/workflows/reusable-10-ci-python.yml@main
    with:
      python-versions: "[\"3.11\", \"3.12\"]"
      primary-python-version: "3.11"
      coverage-min: "85"
      coverage: true
      enable-coverage-delta: true
      baseline-coverage: "80"
      coverage-alert-drop: "2"
      fail-on-coverage-drop: true
      enable-soft-gate: true
      lint: true
      format_check: true
      typecheck: true
      working-directory: .

  ci-monorepo:
    name: Monorepo simulation
    uses: stranske/Workflows/.github/workflows/reusable-10-ci-python.yml@main
    with:
      python-version: "3.11"
      lint: true
      format_check: true
      typecheck: true
      coverage: true
      working-directory: "apps/service-a"

  report-upstream:
    name: Report upstream failures
    needs: [ci-basic, ci-coverage, ci-monorepo]
    if: failure()
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    env:
      WORKFLOWS_PAT: ${{ secrets.WORKFLOWS_PAT }}
    steps:
      - name: Create issue in stranske/Workflows
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.WORKFLOWS_PAT || github.token }}
          script: |
            const failures = [];
            const needs = ${{ toJson(needs) }};
            for (const [job, data] of Object.entries(needs)) {
              if (data.result && data.result !== 'success') {
                failures.push(`${job}: ${data.result}`);
              }
            }
            if (!failures.length) {
              core.info('No failures to report upstream.');
              return;
            }
            if (!process.env.WORKFLOWS_PAT) {
              core.warning('WORKFLOWS_PAT not configured; cannot open upstream issue.');
              return;
            }
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const title = `Integration regression detected in ${context.repo.repo} (run ${context.runNumber})`;
            const body = [
              'The integration consumer detected a regression while running the reusable Python CI workflow.',
              '',
              `Repository: ${context.repo.owner}/${context.repo.repo}`,
              `Ref: ${context.ref}`,
              `Run: ${runUrl}`,
              '',
              'Failing jobs:',
              failures.map((line) => `- ${line}`).join('\n'),
              '',
              'This issue was opened automatically so the workflow library maintainers can investigate.',
            ].join('\n');
            await github.rest.issues.create({
              owner: 'stranske',
              repo: 'Workflows',
              title,
              body,
            });
